name: Release

on:
  push:
    branches: [main]

# Prevent concurrent publishes
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # create tags, push version commit, GitHub releases
      id-token: write   # npm provenance

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for commit analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - run: npm ci
      - run: npm test
      - run: npm run build

      - name: Determine version bump from commits
        id: bump
        run: |
          # Find the latest version tag, or use initial commit
          LATEST_TAG=$(git tag --sort=-v:refname | grep '^v' | head -1 || true)
          if [ -n "$LATEST_TAG" ]; then
            RANGE="$LATEST_TAG..HEAD"
          else
            RANGE="HEAD"
          fi

          # Collect commit messages since last release
          COMMITS=$(git log "$RANGE" --pretty=format:"%s" --no-merges 2>/dev/null || git log --pretty=format:"%s" --no-merges)
          BODIES=$(git log "$RANGE" --pretty=format:"%b" --no-merges 2>/dev/null || git log --pretty=format:"%b" --no-merges)

          # Determine bump type from conventional commit prefixes
          BUMP="none"

          if echo "$BODIES" | grep -qi "BREAKING CHANGE"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?!?:"; then
            BUMP="minor"
          elif echo "$COMMITS" | grep -qE "^(fix|perf|refactor)(\(.+\))?:"; then
            BUMP="patch"
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Detected bump: $BUMP"

      - name: Bump version and publish
        if: steps.bump.outputs.bump != 'none'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          BUMP: ${{ steps.bump.outputs.bump }}
        run: |
          # Configure git for the version commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Bump version in package.json, create commit and tag
          NEW_VERSION=$(npm version "$BUMP" -m "release: v%s")
          echo "Published $NEW_VERSION"

          # Publish to npm with provenance
          npm publish --provenance --access public

          # Push version commit and tag back to main
          git push origin main --follow-tags

      - name: Create GitHub release
        if: steps.bump.outputs.bump != 'none'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          # Changelog from commits since previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep '^v' | sed -n '2p')
          if [ -n "$PREV_TAG" ]; then
            NOTES=$(git log "$PREV_TAG"..HEAD --pretty=format:"- %s" --no-merges | grep -v "^- release:")
          else
            NOTES=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes "$NOTES"
